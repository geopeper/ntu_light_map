```html
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>台大夜間亮度地圖 — Modern Demo</title>

  <!-- Leaflet CDN -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      /* ====== refreshed, low-saturation night palette ====== */
      --bg: rgba(10, 14, 24, .72);
      --bg-strong: rgba(10, 14, 24, .92);
      --stroke: rgba(148, 163, 184, .14);
      --text: #e6e9ef;
      --muted: #9aa4b2;

      --accent: #7aa2ff;   /* cool blue-violet */
      --accent-2: #6ee7d2; /* soft mint/teal */

      --radius: 14px;
      --shadow: 0 8px 24px rgba(0,0,0,.45);
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      font-family: var(--font);
    }
    #map {
      height: 100vh;
      width: 100vw;
    }

    /* ===== Leaflet controls reset a bit ===== */
    .leaflet-control { box-shadow: none; }
    .leaflet-bar a {
      background: rgba(12,16,26,.75);
      color: #eef2f7;
      border: 1px solid rgba(148,163,184,.12);
    }
    .leaflet-bar a:hover {
      background: rgba(20,26,40,.9);
    }

    /* ===== Title pill (top-left) ===== */
    .map-title {
      padding: 10px 12px;
      background: var(--bg);
      color: var(--text);
      border-radius: 999px;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .3px;
      border: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .map-title .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
      box-shadow: 0 0 8px rgba(122,162,255,.6);
    }

    /* ===== Legend (bottom-right) ===== */
    .legend-box {
      padding: 10px 12px;
      background: var(--bg);
      color: var(--text);
      border-radius: var(--radius);
      font-size: 12px;
      line-height: 1.35;
      border: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      min-width: 140px;
    }
    .legend-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,.12);
      flex-shrink: 0;
    }
    .legend-title{
      font-weight: 700;
      margin-bottom: 6px;
      display:flex; align-items:center; gap:6px;
    }
    .legend-title .pill{
      font-size: 10px; color:#0b1020; background:#eef2f7;
      padding:2px 6px; border-radius:999px; font-weight:800;
    }

    /* ===== Sidebar layer panel (right) ===== */
    .layers-panel {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 260px;
      max-height: calc(100vh - 32px);
      background: var(--bg);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform .25s ease, opacity .25s ease;
      z-index: 9999;
    }
    .layers-panel.collapsed{
      transform: translateX(110%);
      opacity: 0;
      pointer-events: none;
    }
    .layers-header{
      padding: 10px 12px;
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg, var(--bg-strong), transparent);
    }
    .layers-header .title{
      font-size: 13px; font-weight: 800; color: var(--text);
      display:flex; align-items:center; gap:8px;
    }
    .layers-header .title .icon{
      width: 18px; height: 18px; border-radius: 6px;
      background: linear-gradient(135deg, #7aa2ff, #6ee7d2);
      box-shadow: 0 0 10px rgba(122,162,255,.35);
    }
    .layers-header button{
      cursor: pointer;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 12px;
      font-weight: 700;
      transition: background .2s ease, transform .06s ease;
    }
    .layers-header button:hover{ background: rgba(255,255,255,.12); }
    .layers-header button:active{ transform: translateY(1px); }

    .layers-body{
      padding: 8px;
      overflow: auto;
    }

    /* Accordion */
    .acc {
      border-radius: 12px;
      border: 1px solid var(--stroke);
      overflow: hidden;
      margin-bottom: 8px;
      background: rgba(15, 23, 42, .55);
    }
    .acc-summary{
      list-style: none;
      cursor: pointer;
      padding: 9px 10px;
      font-size: 12px;
      font-weight: 800;
      color: var(--text);
      display:flex; align-items:center; justify-content:space-between;
      user-select: none;
    }
    .acc-summary::-webkit-details-marker{ display:none; }
    .acc-summary .chev{
      color: var(--muted);
      transition: transform .2s ease;
      font-weight: 900;
    }
    details[open] .acc-summary .chev{
      transform: rotate(90deg);
    }
    .acc-content{
      padding: 6px 8px 8px 8px;
      border-top: 1px solid var(--stroke);
      display:flex; flex-direction:column; gap:4px;
      font-size: 12px;
    }

    /* Checkbox rows */
    .layer-row{
      display:flex; align-items:center; justify-content:space-between;
      padding: 6px 6px;
      border-radius: 8px;
      transition: background .15s ease;
    }
    .layer-row:hover{ background: rgba(255,255,255,.05); }

    .layer-left{
      display:flex; align-items:center; gap:8px; color: var(--text);
    }
    .swatch{
      width: 10px; height: 10px; border-radius: 3px; opacity: .9;
      border: 1px solid rgba(255,255,255,.2);
    }
    .layer-row input[type="checkbox"]{
      width: 16px; height: 16px; accent-color: #8fb0ff;
      cursor: pointer;
    }
    .layer-desc{
      font-size: 11px; color: var(--muted);
      margin-left: 18px; margin-top: -2px;
    }

    /* Floating button to open panel */
    .panel-fab{
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9998;
      background: var(--bg);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 800;
      color: var(--text);
      box-shadow: var(--shadow);
      cursor: pointer;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:none;
      align-items:center; gap:6px;
    }
    .panel-fab .mini{
      width:8px; height:8px; border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(122,162,255,.7);
    }
    .panel-fab.show{ display:inline-flex; }

    @media (max-width: 640px){
      .layers-panel{ width: 220px; }
    }
  </style>
</head>
<body>
<div id="map"></div>

<!-- panel open button (only when collapsed) -->
<button id="panelFab" class="panel-fab">
  <span class="mini"></span> 圖層
</button>

<!-- custom layers sidebar -->
<div id="layersPanel" class="layers-panel">
  <div class="layers-header">
    <div class="title">
      <span class="icon"></span>
      圖層與樣式
    </div>
    <button id="panelClose">收合</button>
  </div>

  <div class="layers-body">
    <!-- 只保留可開關的兩類 -->
    <details class="acc" open>
      <summary class="acc-summary">
        亮度圖層 <span class="chev">›</span>
      </summary>
      <div class="acc-content" id="dataLayers"></div>
    </details>

    <details class="acc" open>
      <summary class="acc-summary">
        邊界 <span class="chev">›</span>
      </summary>
      <div class="acc-content" id="boundaryLayers"></div>
    </details>
  </div>
</div>

<script>
// ========== 1) 初始化地圖 ==========
const map = L.map('map', { zoomControl: false }).setView([25.0173, 121.5398], 16);

// ===== panes: 強制圖層上下順序 =====
map.createPane('brightnessPane'); // 最上層
map.getPane('brightnessPane').style.zIndex = 650;

map.createPane('safetyPane');     // 中層
map.getPane('safetyPane').style.zIndex = 600;

map.createPane('protectPane');    // 下層
map.getPane('protectPane').style.zIndex = 550;

// 底圖（常駐，不提供關閉）
const baseTile = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  {
    attribution: '&copy; OSM contributors &copy; CARTO',
    subdomains: 'abcd',
    maxZoom: 20
  }
).addTo(map);

// ========== 2) 自訂左上角標題 ==========
const titleControl = L.control({ position: 'topleft' });
titleControl.onAdd = function () {
  const div = L.DomUtil.create('div', 'map-title');
  div.innerHTML = `<span class="dot"></span> 台大夜間亮度地圖`;
  return div;
};
titleControl.addTo(map);

// ====== 3) Custom Layer Panel Logic ======
const panel = document.getElementById('layersPanel');
const fab = document.getElementById('panelFab');
document.getElementById('panelClose').onclick = () => {
  panel.classList.add('collapsed');
  fab.classList.add('show');
};
fab.onclick = () => {
  panel.classList.remove('collapsed');
  fab.classList.remove('show');
};

// Prevent map drag when interacting panel
L.DomEvent.disableClickPropagation(panel);
L.DomEvent.disableScrollPropagation(panel);

// helper to add checkbox row into panel
function addLayerToggle(containerId, {
  label,
  layer,
  checked = true,
  swatchColor = '#999',
  desc = ''
}) {
  const container = document.getElementById(containerId);

  const row = document.createElement('div');
  row.className = 'layer-row';

  const left = document.createElement('div');
  left.className = 'layer-left';

  const swatch = document.createElement('span');
  swatch.className = 'swatch';
  swatch.style.background = swatchColor;

  const text = document.createElement('div');
  text.innerHTML = `<div>${label}</div>${desc ? `<div class="layer-desc">${desc}</div>` : ''}`;

  left.appendChild(swatch);
  left.appendChild(text);

  const cb = document.createElement('input');
  cb.type = 'checkbox';
  cb.checked = checked;

  cb.onchange = () => {
    if (cb.checked) layer.addTo(map);
    else map.removeLayer(layer);
  };

  row.appendChild(left);
  row.appendChild(cb);
  container.appendChild(row);

  // initial state
  if (checked) layer.addTo(map);
}

// ========== 4) 台大範圍線（常駐，不提供關閉） ==========
fetch('/ntu_light_map/data/ntu_area.geojson')
  .then(r => r.json())
  .then(geo => {
    const ntuLine = L.geoJSON(geo, {
      style: { color: '#eef2f7', weight: 1.05, opacity: .9 }
    }).addTo(map);

    map.fitBounds(ntuLine.getBounds());
  });

// ========== 5) Overlay 依序載入：亮度 → 安全 → 光害 ==========
let brightnessLegend;

async function loadJSON(url){
  const r = await fetch(url);
  return await r.json();
}

(async function loadOrderedOverlays(){

  // --- (1) 實測亮度六邊形（最上層） ---
  const geoBrightness = await loadJSON('/ntu_light_map/data/merge_sur_zhoushan.geojson');

  const rawVals = geoBrightness.features
    .map(f => Number(f.properties?.brightness_filled))
    .filter(v => Number.isFinite(v) && v >= 0);

  if (rawVals.length === 0) {
    console.warn('merge_sur_zhoushan: brightness_filled 無有效數值');
    return;
  }

  const aboveOne = rawVals.filter(v => v > 1).sort((a,b)=>a-b);

  function quantile(sortedArr, p) {
    if (sortedArr.length === 0) return 1;
    const pos = (sortedArr.length - 1) * p;
    const base = Math.floor(pos);
    const rest = pos - base;
    if (base + 1 < sortedArr.length) {
      return sortedArr[base] + rest * (sortedArr[base + 1] - sortedArr[base]);
    } else {
      return sortedArr[base];
    }
  }

  const q25 = quantile(aboveOne, 0.25);
  const q50 = quantile(aboveOne, 0.50);
  const q75 = quantile(aboveOne, 0.75);
  const q100 = quantile(aboveOne, 1.00);

  // ===== refreshed brightness ramp (deep navy -> cool white) =====
  const ramp = [
    '#0b1020',  // near-black navy
    '#1f2a5a',  // deep indigo
    '#2f6f9f',  // muted blue
    '#6fd0c2',  // soft teal
    '#f3f6ff'   // cool white
  ];

  function getColor(v) {
    if (!Number.isFinite(v)) return '#7b8492';
    if (v <= 1) return ramp[0];
    if (v <= q25) return ramp[1];
    if (v <= q50) return ramp[2];
    if (v <= q75) return ramp[3];
    return ramp[4];
  }

  const measuredLayer = L.geoJSON(geoBrightness, {
    pane: 'brightnessPane',
    style: f => {
      const v = Number(f.properties?.brightness_filled);
      return {
        color: 'rgba(6, 10, 18, .55)',  // softer edge
        weight: 0.25,
        fillColor: getColor(v),
        fillOpacity: 0.9
      };
    },
    onEachFeature: (feature, layer) => {
      const v = Number(feature.properties?.brightness_filled);
      const luxStr = Number.isFinite(v) ? v.toFixed(2) : 'NA';
      const id = feature.properties?.id ?? '(無 ID)';
      layer.bindPopup(`
        <div style="font: 12px/1.5 system-ui, sans-serif; min-width:120px;">
          <div style="font-weight:800; font-size:13px; margin-bottom:4px;">Hex ${id}</div>
          <div style="color:#0b1020; background:#f1f5fb; padding:4px 6px; border-radius:6px; display:inline-block;">
            ${luxStr} lux
          </div>
        </div>
      `);
    }
  });

  addLayerToggle('dataLayers', {
    label: '實測亮度六邊形',
    layer: measuredLayer,
    checked: true,
    swatchColor: ramp[4]
  });

  // --- legend (亮度) ---
  if (brightnessLegend) brightnessLegend.remove();
  brightnessLegend = L.control({ position: 'bottomright' });
  brightnessLegend.onAdd = function () {
    const div = L.DomUtil.create('div', 'legend-box');

    function fmt(x) {
      if (!Number.isFinite(x)) return 'NA';
      if (Math.abs(x) >= 1000) return x.toFixed(0);
      return x.toFixed(2);
    }

    const rows = [
      { color: ramp[0], label: `0 – 1` },
      { color: ramp[1], label: `1 – ${fmt(q25)}` },
      { color: ramp[2], label: `${fmt(q25)} – ${fmt(q50)}` },
      { color: ramp[3], label: `${fmt(q50)} – ${fmt(q75)}` },
      { color: ramp[4], label: `${fmt(q75)} – ${fmt(q100)}` },
    ];

    let html = `
      <div class="legend-title">
        <span class="pill">亮度（lux）</span>
      </div>
    `;
    rows.forEach(row => {
      html += `
        <div class="legend-row">
          <span class="legend-color" style="background:${row.color};"></span>
          <span>${row.label}</span>
        </div>
      `;
    });

    div.innerHTML = html;
    return div;
  };
  brightnessLegend.addTo(map);


  // --- (2) 道路安全框線（中層） ---
  const geoSafety = await loadJSON('/ntu_light_map/data/hex_hit_with_safe.geojson');

  // ===== refreshed safety colors (soft, low-sat) =====
  function safetyColor(s) {
    if (s === 1) return '#7bcfa1';  // soft green
    if (s === 2) return '#e6c07a';  // soft amber
    if (s === 3) return '#e08a8a';  // soft red
    return '#8aa2d6';              // soft blue
  }

  const safetyHexLayer = L.geoJSON(geoSafety, {
    pane: 'safetyPane',
    style: f => {
      const s = Number(f.properties?.safe_worst);
      return {
        color: safetyColor(s),
        weight: 1.05,
        opacity: 0.9,
        fillOpacity: 0,
        fill: false
      };
    },
    onEachFeature: (feature, layer) => {
      const id = feature.properties?.id ?? '(無 ID)';
      const sWorst = feature.properties?.safe_worst;
      const sMean = feature.properties?.safe_mean;
      layer.bindPopup(`
        <div style="font:12px/1.5 system-ui,sans-serif;">
          <b>Hex ID</b>：${id}<br/>
          <b>safe_worst</b>：${sWorst}<br/>
          <b>safe_mean</b>：${(sMean!=null)?Number(sMean).toFixed(2):'NA'}
        </div>
      `);
    }
  });

  addLayerToggle('boundaryLayers', {
    label: '道路安全框線',
    layer: safetyHexLayer,
    checked: true,
    swatchColor: '#7bcfa1'
  });


  // --- (3) 光害控制區（最下層） ---
  const geoProtect = await loadJSON('/ntu_light_map/data/protect_square_4326.geojson');

  // ===== refreshed protect area (soft lavender) =====
  const protectLayer = L.geoJSON(geoProtect, {
    pane: 'protectPane',
    style: {
      color: '#b79af5',
      fillColor: '#b79af5',
      fillOpacity: 0.22,
      weight: 0
    }
  });

  addLayerToggle('boundaryLayers', {
    label: '光害控制區',
    layer: protectLayer,
    checked: true,
    swatchColor: '#b79af5'
  });

})();
</script>
</body>
</html>
```
