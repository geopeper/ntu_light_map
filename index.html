<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>台大夜間亮度地圖 — Demo</title>

  <!-- Leaflet CDN -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    .map-title {
      padding: 8px 12px;
      background: rgba(15, 23, 42, 0.9);
      color: #f9fafb;
      border-radius: 8px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
    }
    .legend-box {
      padding: 8px 10px;
      background: rgba(15, 23, 42, 0.9);
      color: #f9fafb;
      border-radius: 8px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-size: 12px;
      line-height: 1.3;
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
    }
    .legend-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 3px 0;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #0004;
      flex-shrink: 0;
    }
    .leaflet-control-layers-expanded {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-size: 12px;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
// ========== 1) 初始化地圖 ==========
const map = L.map('map').setView([25.0173, 121.5398], 16);

// 底圖
const baseTile = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  {
    attribution: '&copy; OSM contributors &copy; CARTO',
    subdomains: 'abcd',
    maxZoom: 20
  }
).addTo(map);

// 圖層控制（先建好，之後慢慢 addOverlay）
const layersControl = L.control.layers(
  { '深色底圖': baseTile },
  {},
  { collapsed: false }
).addTo(map);

// ========== 2) 左上角標題「台大夜間亮度地圖」 ==========
const titleControl = L.control({ position: 'topleft' });
titleControl.onAdd = function () {
  const div = L.DomUtil.create('div', 'map-title');
  div.innerHTML = '台大夜間亮度地圖';
  return div;
};
titleControl.addTo(map);

// ========== 3) 固定顯示的圖層：ntu_area + hex_empty ==========

// 3.1 台大範圍線
fetch('/ntu_light_map/data/ntu_area.geojson')
  .then(r => r.json())
  .then(geo => {
    const ntuLine = L.geoJSON(geo, {
      style: { color: '#ffffff', weight: 1 }
    }).addTo(map);

    // 初始視野
    map.fitBounds(ntuLine.getBounds());
  });

// 3.2 空六邊形網格（白框、透明填色）
fetch('/ntu_light_map/data/hex_empty_4326.geojson')
  .then(r => r.json())
  .then(geo => {
    L.geoJSON(geo, {
      style: {
        color: '#ffffff',
        weight: 0.5,
        fillOpacity: 0,
        fill: false
      }
    }).addTo(map);
  });

// ========== 4) 實測亮度六邊形：merge_sur_zhoushan ==========
let brightnessLegend;

fetch('/ntu_light_map/data/merge_sur_zhoushan.geojson')
  .then(r => r.json())
  .then(geo => {
    // 4.1 取出亮度數值
    const rawVals = geo.features
      .map(f => Number(f.properties?.brightness_filled))
      .filter(v => Number.isFinite(v) && v >= 0);

    if (rawVals.length === 0) {
      console.warn('merge_sur_zhoushan: brightness_filled 無有效數值');
      return;
    }

    // 固定第一級：0–1
    const aboveOne = rawVals.filter(v => v > 1);
    aboveOne.sort((a, b) => a - b);

    // 簡單 quantile 函式
    function quantile(sortedArr, p) {
      if (sortedArr.length === 0) return 1;
      const pos = (sortedArr.length - 1) * p;
      const base = Math.floor(pos);
      const rest = pos - base;
      if (base + 1 < sortedArr.length) {
        return sortedArr[base] + rest * (sortedArr[base + 1] - sortedArr[base]);
      } else {
        return sortedArr[base];
      }
    }

    // 剩下的 range（>1）切四等分 → 共 5 級
    const q25 = quantile(aboveOne, 0.25);
    const q50 = quantile(aboveOne, 0.50);
    const q75 = quantile(aboveOne, 0.75);
    const q100 = quantile(aboveOne, 1.00);

    // 莫蘭迪深藍到亮黃（低→高）
    const ramp = [
      '#222c40', // 0–1
      '#3c4a63', // 1–q25
      '#6a7485', // q25–q50
      '#b4aa86', // q50–q75
      '#f4de84'  // q75–max
    ];

    function getColor(v) {
      if (!Number.isFinite(v)) return '#999999';
      if (v <= 1) return ramp[0];
      if (v <= q25) return ramp[1];
      if (v <= q50) return ramp[2];
      if (v <= q75) return ramp[3];
      return ramp[4];
    }

    const style = f => {
      const v = Number(f.properties?.brightness_filled);
      return {
        color: '#0f172a',
        weight: 0.3,
        fillColor: getColor(v),
        fillOpacity: 0.9
      };
    };

    const measuredLayer = L.geoJSON(geo, {
      style,
      onEachFeature: (feature, layer) => {
        const v = Number(feature.properties?.brightness_filled);
        const luxStr = Number.isFinite(v) ? v.toFixed(2) : 'NA';
        const id = feature.properties?.id ?? '(無 ID)';
        layer.bindPopup(`
          <div style="font: 12px/1.4 system-ui, sans-serif">
            <b>Hex ID</b>：${id}<br/>
            <b>亮度（lux）</b>：${luxStr}
          </div>
        `);
      }
    }).addTo(map);

    // 加到圖層控制，可以勾選
    layersControl.addOverlay(measuredLayer, '實測亮度六邊形');

    // 4.2 建立圖例（右下角）
    if (brightnessLegend) brightnessLegend.remove();

    brightnessLegend = L.control({ position: 'bottomright' });
    brightnessLegend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend-box');

      function fmt(x) {
        if (!Number.isFinite(x)) return 'NA';
        if (Math.abs(x) >= 1000) return x.toFixed(0);
        return x.toFixed(2);
      }

      const rows = [];

      // 0–1
      rows.push({
        color: ramp[0],
        label: `0 – 1`
      });

      // 1–q25
      rows.push({
        color: ramp[1],
        label: `1 – ${fmt(q25)}`
      });

      // q25–q50
      rows.push({
        color: ramp[2],
        label: `${fmt(q25)} – ${fmt(q50)}`
      });

      // q50–q75
      rows.push({
        color: ramp[3],
        label: `${fmt(q50)} – ${fmt(q75)}`
      });

      // q75–max
      rows.push({
        color: ramp[4],
        label: `${fmt(q75)} – ${fmt(q100)}`
      });

      let html = '<div style="margin-bottom:4px;font-weight:600;">亮度（lux）</div>';
      rows.forEach(row => {
        html += `
          <div class="legend-row">
            <span class="legend-color" style="background:${row.color};"></span>
            <span>${row.label}</span>
          </div>
        `;
      });

      div.innerHTML = html;
      return div;
    };
    brightnessLegend.addTo(map);
  });

// ========== 5) 光害控制區：protect_square（可開關） ==========
fetch('/ntu_light_map/data/protect_square_4326.geojson')
  .then(r => r.json())
  .then(geo => {
    const protectLayer = L.geoJSON(geo, {
      style: {
        color: '#f97316',
        fillColor: '#f97316',
        fillOpacity: 1,
        weight: 1.2
      }
    }).addTo(map);

    layersControl.addOverlay(protectLayer, '光害控制區（示意）');
  });

</script>
</body>
</html>
